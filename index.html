<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Do I need a Fractional Head of People?</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f4f4f4;
    }
    .container {
      width: 90%;
      max-width: 600px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-top: 20px;
    }
    .progress-bar-track {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 4px;
      height: 8px;
      margin-bottom: 20px;
    }
    .progress-bar {
      background-color: #445953;
      height: 8px;
      border-radius: 4px;
      width: 0%;
      transition: width 0.4s ease;
    }
    h1, h2 { color: #445953; }
    button {
      background-color: #445953;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-top: 10px;
      margin-right: 8px;
    }
    button:hover { background-color: #D57A4C; }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    .hidden { display: none; }
    .question-block {
      margin-bottom: 18px;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    .question-block p { margin: 0 0 8px 0; font-weight: 500; }
    .radio-group { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #step-info { color: #666; font-size: 14px; margin-top: 10px; }
    .score-bar-wrap {
      background: #e0e0e0;
      border-radius: 4px;
      height: 10px;
      margin: 4px 0 10px 0;
    }
    .score-bar {
      height: 10px;
      border-radius: 4px;
      background: #445953;
      transition: width 0.5s ease;
    }
    .tier-badge {
      display: inline-block;
      padding: 8px 18px;
      border-radius: 20px;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 12px;
      color: white;
    }
    .tier-high-priority { background-color: #dc3545; }
    .tier-build-now     { background-color: #D57A4C; }
    .tier-emerging      { background-color: #ffc107; color: #333; }
    .tier-foundation    { background-color: #445953; }
    .risk-item {
      background: #fff3cd;
      border-left: 4px solid #D57A4C;
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 4px;
    }
    .action-item {
      background: #d1ecf1;
      border-left: 4px solid #445953;
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 4px;
    }
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1000;
    }
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    .modal-content {
      background-color: white;
      padding: 24px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
    }
    .modal-content label {
      display: block;
      margin-top: 12px;
      margin-bottom: 4px;
      font-weight: 500;
    }
    .modal-content input[type="text"],
    .modal-content input[type="email"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .modal-content input[type="checkbox"] { margin-right: 6px; }
    #success-message { color: green; font-weight: bold; }
    #error-message { color: red; font-weight: bold; }
    .rating-scale-list {
      list-style: none;
      padding: 0;
      margin: 0 0 16px 0;
      font-size: 14px;
    }
    .rating-scale-list li {
      margin-bottom: 4px;
    }
    .sending-spinner {
      display: inline-block;
      margin-left: 8px;
      font-size: 13px;
      color: #666;
    }
    .section-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    .risk-label {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 8px;
      color: white;
    }
    .risk-stable       { background-color: #445953; }
    .risk-watch        { background-color: #ffc107; color: #333; }
    .risk-action       { background-color: #D57A4C; }
    .risk-high         { background-color: #dc3545; }
    .cta-primary {
      background-color: #D57A4C;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      margin-top: 10px;
      margin-right: 8px;
      transition: background-color 0.3s;
    }
    .cta-primary:hover { background-color: #b8603a; }
    .cta-secondary {
      background-color: #445953;
    }
  </style>
</head>
<body>

<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<div class="container">

  <!-- Progress Bar -->
  <div class="progress-bar-track">
    <div class="progress-bar" id="progress-bar"></div>
  </div>

  <!-- Landing -->
  <div id="landing" class="step">
    <h1>Do I need a Fractional Head of People?</h1>
    <h2>Take this assessment to find out!</h2>
    <p>
      This 5-minute assessment will help you determine whether a Fractional Head of People
      is something you should consider now or can revisit later. You'll receive a breakdown
      of your score across three key areas, your top risk signals, and recommended next
      steps tailored to where you are today.
    </p>
    <button id="start-btn">Start</button>
  </div>

  <!-- About -->
  <div id="about" class="step hidden">
    <h2>About This Assessment</h2>
    <ul>
      <li>Assess your current people systems.</li>
      <li>Identify potential risks and gaps.</li>
      <li>Receive tailored recommendations.</li>
    </ul>
    <p><strong>Privacy Note:</strong> We'll email your results only if you choose.</p>
    <button id="next-to-assessment">Next</button>
  </div>

  <!-- Assessment -->
  <div id="assessment" class="step hidden">
    <p class="section-label" id="section-label"></p>
    <h2 id="category-title"></h2>
    <p style="font-size:13px;color:#555;margin-top:0;" id="section-description"></p>
    <p><strong>Rating Scale:</strong></p>
    <ul class="rating-scale-list">
      <li>1 = Strongly Disagree</li>
      <li>2 = Disagree</li>
      <li>3 = Neutral / Unsure</li>
      <li>4 = Agree</li>
      <li>5 = Strongly Agree</li>
    </ul>
    <div id="questions"></div>
    <div style="margin-top:16px;">
      <button id="back-btn">Back</button>
      <button id="next-btn" disabled>Next</button>
    </div>
    <p id="step-info"></p>
  </div>

  <!-- Results -->
  <div id="results" class="hidden">
    <h2>Your Results</h2>
    <div id="result-tier"></div>
    <div id="overall-score"></div>
    <div id="category-scores"></div>
    <div id="top-risk-signals"></div>
    <div id="recommended-actions"></div>
    <div id="cta-buttons" style="margin-top:16px;"></div>
    <button id="restart-btn" style="margin-top:8px;">Start Over</button>
  </div>

</div>

<!-- Lead Capture Modal -->
<div class="modal" id="lead-capture-modal">
  <div class="modal-content">
    <h3>Get Your Action Plan</h3>
    <label for="first-name">First Name (optional):</label>
    <input type="text" id="first-name" placeholder="Your first name">
    <label for="email">Email (required):</label>
    <input type="email" id="email" placeholder="you@example.com">
    <label style="margin-top:12px; display:flex; align-items:flex-start; gap:6px;">
      <input type="checkbox" id="insights-checkbox" checked style="margin-top:3px;">
      <span>Send me occasional insights on people systems (max 1/month).</span>
    </label>
    <button id="submit-email" style="margin-top:14px;">Submit</button>
    <span id="sending-indicator" class="sending-spinner hidden">Sending...</span>
    <p id="success-message" class="hidden">Done - check your inbox.</p>
    <p id="error-message" class="hidden">Something went wrong. Please try again.</p>
  </div>
</div>

<script>
  // Initialize EmailJS
  emailjs.init('Bm7DARr7qy74Rf5UN');

  // ─── Data ────────────────────────────────────────────────────────────────────

  const sections = [
    {
      key: "Operating Clarity & Scale Readiness",
      label: "Section 1 of 3",
      description: "How clearly your org runs today and how much risk or drag is hiding in the system.",
      questions: [
        "Decisions stall because ownership is unclear.",
        "Cross-team handoffs regularly break because who does what isn't explicit.",
        "We're one people issue (performance, conflict, termination) away from chaos.",
        "Policies and processes are ad hoc or unclear, creating inconsistency and risk.",
        "People data (headcount, compensation, performance, attrition) is messy or not visible, so decisions are slower."
      ],
      // item keys: A1, A4, E1, E2, E3 — stored as indices 0-4
    },
    {
      key: "Hiring Quality & Ramp",
      label: "Section 2 of 3",
      description: "How effectively you hire, evaluate, and get new people productive.",
      questions: [
        "We've had a costly mishire in the last 6-9 months (or we're worried we're close).",
        "New hires take longer than 60-90 days to become meaningfully productive.",
        "Interviewing is inconsistent and different interviewers evaluate different things."
      ],
      // item keys: B1, B2, B3
    },
    {
      key: "Leaders, Performance & Retention",
      label: "Section 3 of 3",
      description: "How well leaders drive performance, consistency, and team health.",
      questions: [
        "Leaders avoid hard conversations, so issues linger too long.",
        "High performers are carrying too much because low performance isn't addressed quickly.",
        "Great performance isn't clearly defined by role, level, or function.",
        "Leaders need more support with coaching, feedback, delegation, and prioritization.",
        "We've lost, or nearly lost, a key employee unexpectedly in the last 12 months.",
        "We don't have a reliable way to understand why people stay or leave.",
        "Recognition and growth opportunities feel inconsistent across teams.",
        "Culture and communication feel different depending on which leader you work for."
      ],
      // item keys: C1, C2, C3, C4, D1, D2, D3, D4
    }
  ];

  // ─── State ───────────────────────────────────────────────────────────────────

  const totalSteps = sections.length;
  let currentStep = 0;
  const answers = {}; // key: "sectionIndex_questionIndex" -> raw 1-5 value

  // Global result storage for email
  let globalScores = {};
  let globalTier = '';
  let globalOverallScore = 0;
  let globalActions = [];
  let globalRawAnswers = {};

  // ─── Helpers ─────────────────────────────────────────────────────────────────

  function answerKey(sectionIdx, qIdx) {
    return `s${sectionIdx}_q${qIdx}`;
  }

  function normalize(response) {
    return ((response - 1) / 4) * 100;
  }

  function isCurrentStepAnswered() {
    const section = sections[currentStep];
    for (let i = 0; i < section.questions.length; i++) {
      const key = answerKey(currentStep, i);
      if (answers[key] === undefined || answers[key] === null) return false;
    }
    return true;
  }

  function updateNextButton() {
    const answered = isCurrentStepAnswered();
    nextBtn.disabled = !answered;
    nextBtn.textContent = currentStep === totalSteps - 1 ? 'See My Results' : 'Next';
  }

  function getSectionRiskLabel(score) {
    if (score >= 80) return { label: 'High Risk',      cls: 'risk-high' };
    if (score >= 60) return { label: 'Action Needed',  cls: 'risk-action' };
    if (score >= 35) return { label: 'Watch',          cls: 'risk-watch' };
    return           { label: 'Stable',                cls: 'risk-stable' };
  }

  // ─── Load Assessment Step ────────────────────────────────────────────────────

  function loadAssessment() {
    const section = sections[currentStep];
    document.getElementById('section-label').textContent    = section.label;
    document.getElementById('category-title').textContent   = section.key;
    document.getElementById('section-description').textContent = section.description;

    const container = document.getElementById('questions');
    container.innerHTML = '';

    section.questions.forEach((question, index) => {
      const key = answerKey(currentStep, index);
      const block = document.createElement('div');
      block.className = 'question-block';

      const p = document.createElement('p');
      p.textContent = question;
      block.appendChild(p);

      const radioGroup = document.createElement('div');
      radioGroup.className = 'radio-group';

      for (let val = 1; val <= 5; val++) {
        const label = document.createElement('label');
        const radio = document.createElement('input');
        radio.type  = 'radio';
        radio.name  = key;
        radio.value = val;

        if (answers[key] === val) radio.checked = true;

        (function(capturedVal, capturedKey) {
          radio.addEventListener('change', function() {
            if (this.checked) {
              answers[capturedKey] = capturedVal;
              updateNextButton();
            }
          });
        })(val, key);

        label.appendChild(radio);
        label.appendChild(document.createTextNode(' ' + val));
        radioGroup.appendChild(label);
      }

      block.appendChild(radioGroup);
      container.appendChild(block);
    });

    progressBar.style.width = `${((currentStep + 1) / totalSteps) * 100}%`;
    document.getElementById('step-info').textContent = `Step ${currentStep + 1} of ${totalSteps}`;
    backBtn.style.display = currentStep === 0 ? 'none' : 'inline-block';
    updateNextButton();
  }

  // ─── Element Refs ────────────────────────────────────────────────────────────

  const progressBar      = document.getElementById('progress-bar');
  const nextBtn          = document.getElementById('next-btn');
  const backBtn          = document.getElementById('back-btn');
  const leadCaptureModal = document.getElementById('lead-capture-modal');
  const emailInput       = document.getElementById('email');
  const successMessage   = document.getElementById('success-message');
  const errorMessage     = document.getElementById('error-message');
  const sendingIndicator = document.getElementById('sending-indicator');

  // ─── Navigation ──────────────────────────────────────────────────────────────

  document.getElementById('start-btn').addEventListener('click', () => {
    document.getElementById('landing').classList.add('hidden');
    document.getElementById('about').classList.remove('hidden');
  });

  document.getElementById('next-to-assessment').addEventListener('click', () => {
    document.getElementById('about').classList.add('hidden');
    document.getElementById('assessment').classList.remove('hidden');
    currentStep = 0;
    loadAssessment();
  });

  backBtn.addEventListener('click', () => {
    if (currentStep > 0) { currentStep--; loadAssessment(); }
  });

  nextBtn.addEventListener('click', () => {
    if (!isCurrentStepAnswered()) return;
    if (currentStep < totalSteps - 1) { currentStep++; loadAssessment(); }
    else showResults();
  });

  // ─── Scoring ─────────────────────────────────────────────────────────────────

  function computeScores() {
    const sectionScores = {};
    sections.forEach((section, sIdx) => {
      let total = 0;
      section.questions.forEach((_, qIdx) => {
        const key = answerKey(sIdx, qIdx);
        total += normalize(answers[key] || 1);
      });
      sectionScores[section.key] = total / section.questions.length;
    });

    const overallScore = (
      sectionScores["Operating Clarity & Scale Readiness"] +
      sectionScores["Hiring Quality & Ramp"] +
      sectionScores["Leaders, Performance & Retention"]
    ) / 3;

    return { sectionScores, overallScore };
  }

  function determineTier(overallScore) {
    if (overallScore >= 80) return "High Priority";
    if (overallScore >= 60) return "Build Now";
    if (overallScore >= 35) return "Emerging";
    return "Foundation Strong";
  }

  // ─── Recommendation Engine ───────────────────────────────────────────────────

  function getRecommendations(sectionScores, overallScore) {
    const rec = [];
    const s = sectionScores;
    const op  = s["Operating Clarity & Scale Readiness"];
    const hi  = s["Hiring Quality & Ramp"];
    const mgr = s["Leaders, Performance & Retention"];

    // Raw answers by section for item-level triggers
    // Section 0 (Operating): indices 0=A1, 1=A4, 2=E1, 3=E2, 4=E3
    // Section 1 (Hiring):    indices 0=B1, 1=B2, 2=B3
    // Section 2 (Manager):   indices 0=C1, 1=C2, 2=C3, 3=C4, 4=D1, 5=D2, 6=D3, 7=D4
    const a = (sIdx, qIdx) => answers[answerKey(sIdx, qIdx)] || 1;

    // 12 - Fractional Head of People (top 3 if triggered)
    if (overallScore >= 70 || (op >= 60 && mgr >= 60) ||
        [op, hi, mgr].filter(x => x >= 60).length >= 2 ||
        Math.max(op, hi, mgr) >= 80) {
      rec.push("Consider hiring a Fractional Head of People / Fractional CPO to build the operating foundation, improve leader leverage, and reduce execution drag while your company scales.");
    }

    // 9 - 90-day people operating plan
    if (overallScore >= 60 || [op, hi, mgr].filter(x => x >= 60).length >= 2) {
      rec.push("Create a 90-day people operating plan focused on the top 2 to 3 risk areas with clear owners, milestones, and success measures.");
    }

    // 11 - Light-touch advisory
    if (!rec.some(r => r.includes('Fractional')) &&
        (overallScore >= 35 && overallScore < 60 ||
         [op, hi, mgr].filter(x => x >= 60).length === 1)) {
      rec.push("Consider a light-touch people advisory engagement to prioritize fixes, sequence the work, and support leaders without overbuilding too early.");
    }

    // 1 - RACI / decision ownership
    if (a(0,0) >= 4 || a(0,1) >= 4 || op >= 60) {
      rec.push("Create a simple RACI for your highest-friction cross-functional decisions and workflows to reduce stalled decisions and broken handoffs.");
    }

    // 2 - Document core people policies
    if (a(0,3) >= 4 || op >= 60) {
      rec.push("Document your core people policies and processes to create a consistent baseline and reduce leader-by-leader variation.");
    }

    // 3 - People metrics dashboard
    if (a(0,4) >= 4 || (a(0,2) >= 4 && a(0,4) >= 3)) {
      rec.push("Create a basic people dashboard (headcount, open roles, time to fill, ramp progress, attrition, performance status) so leaders can make faster, cleaner decisions.");
    }

    // 4 - Standardize interviewing
    if (a(1,0) >= 4 || a(1,2) >= 4 || hi >= 60) {
      rec.push("Standardize your interview process with role-based scorecards, interviewer calibration, and a clear decision process to reduce mis-hire risk.");
    }

    // 5 - Onboarding and ramp plans
    if (a(1,1) >= 4 || hi >= 60) {
      rec.push("Define a consistent onboarding checklist and 30-60-90 day ramp plan for priority roles so new hires become productive faster.");
    }

    // 6 - Leader coaching
    if (a(2,0) >= 4 || a(2,3) >= 4 || mgr >= 60) {
      rec.push("Introduce structured leader coaching (or a peer learning cohort) focused on feedback, delegation, prioritization, and performance conversations.");
    }

    // 7 - Define performance expectations
    if (a(2,1) >= 4 || a(2,2) >= 4 || mgr >= 60) {
      rec.push("Define what great performance looks like by role and level so leaders can coach consistently and address low performance earlier.");
    }

    // 8 - Stay interviews
    if (a(2,4) >= 4 || a(2,5) >= 4 || a(2,6) >= 4 || a(2,7) >= 4 || mgr >= 60) {
      rec.push("Run stay interviews with key employees this quarter and review retention signals by team to identify preventable attrition risk early.");
    }

    // 10 - Re-take (always last)
    rec.push("Set a calendar reminder to re-take this assessment in 90 days and compare scores by section to track progress.");

    // Cap at 5 unique recommendations (re-take always included as last)
    const retak = rec.pop(); // remove re-take temporarily
    const deduped = [...new Set(rec)].slice(0, 4);
    deduped.push(retak); // add back as final
    return deduped;
  }

  // ─── Show Results ─────────────────────────────────────────────────────────────

  function showResults() {
    const { sectionScores, overallScore } = computeScores();
    const tier    = determineTier(overallScore);
    const actions = getRecommendations(sectionScores, overallScore);

    globalScores       = JSON.parse(JSON.stringify(sectionScores));
    globalTier         = String(tier);
    globalOverallScore = parseFloat(overallScore);
    globalActions      = actions.slice();

    document.getElementById('assessment').classList.add('hidden');
    document.getElementById('results').classList.remove('hidden');

    displayResults(overallScore, tier, sectionScores, actions);
  }

  function displayResults(overallScore, tier, sectionScores, actions) {
    const tierColors = {
      "High Priority":   "tier-high-priority",
      "Build Now":       "tier-build-now",
      "Emerging":        "tier-emerging",
      "Foundation Strong": "tier-foundation"
    };

    const tierDescriptions = {
      "High Priority":
        "People-system risk is likely slowing growth and increasing operational strain. This is a strong signal to bring in experienced people leadership support now.",
      "Build Now":
        "Multiple people-system issues are likely affecting execution, leader effectiveness, or hiring quality. A structured people operating plan is recommended in the near term.",
      "Emerging":
        "Early signals are present. It is worth planning now so issues do not compound as you grow. A light-touch engagement or targeted support may be beneficial.",
      "Foundation Strong":
        "Your people systems appear relatively stable for your current stage. Keep monitoring and strengthen a few areas before they become bottlenecks."
    };

    document.getElementById('result-tier').innerHTML = `
      <span class="tier-badge ${tierColors[tier]}">${tier}</span>
      <p>${tierDescriptions[tier]}</p>
    `;

    document.getElementById('overall-score').innerHTML = `
      <h3>Overall Score: ${overallScore.toFixed(1)} / 100</h3>
      <div class="score-bar-wrap">
        <div class="score-bar" style="width:${overallScore}%"></div>
      </div>
      <p style="font-size:13px;color:#666;">
        Higher scores indicate stronger agreement with problem statements,
        suggesting a greater need for people leadership support.
      </p>
    `;

    let catHTML = '<h3>Section Breakdown</h3>';
    sections.forEach(section => {
      const s    = sectionScores[section.key].toFixed(1);
      const risk = getSectionRiskLabel(parseFloat(s));
      catHTML += `
        <p style="margin:4px 0 2px 0;">
          <strong>${section.key}</strong>: ${s} / 100
          <span class="risk-label ${risk.cls}">${risk.label}</span>
        </p>
        <div class="score-bar-wrap">
          <div class="score-bar" style="width:${s}%"></div>
        </div>
      `;
    });
    document.getElementById('category-scores').innerHTML = catHTML;

    // Top Risk Signals
    const highRisk    = sections.filter(s => sectionScores[s.key] >= 80).sort((a,b) => sectionScores[b.key] - sectionScores[a.key]);
    const actionNeeded = sections.filter(s => sectionScores[s.key] >= 60 && sectionScores[s.key] < 80).sort((a,b) => sectionScores[b.key] - sectionScores[a.key]);
    const watching     = sections.filter(s => sectionScores[s.key] >= 50 && sectionScores[s.key] < 60).sort((a,b) => sectionScores[b.key] - sectionScores[a.key]);

    const riskList = [...highRisk, ...actionNeeded].slice(0, 3);

    let riskHTML = '<h3>Top Risk Signals</h3>';
    if (riskList.length === 0) {
      if (watching.length > 0) {
        riskHTML += `<p>No categories are currently in the high-risk zone, but the following areas are emerging and worth monitoring: ${watching.map(s => s.key).join(', ')}.</p>`;
      } else {
        riskHTML += '<p>No categories are currently in the high-risk zone.</p>';
      }
    } else {
      riskList.forEach(s => {
        const risk = getSectionRiskLabel(sectionScores[s.key]);
        riskHTML += `<div class="risk-item"><strong>${s.key}</strong> - Score: ${sectionScores[s.key].toFixed(1)} <span class="risk-label ${risk.cls}">${risk.label}</span></div>`;
      });
    }
    document.getElementById('top-risk-signals').innerHTML = riskHTML;

    let actHTML = '<h3>Recommended Next Steps</h3>';
    actions.forEach(a => {
      actHTML += `<div class="action-item">${a}</div>`;
    });
    document.getElementById('recommended-actions').innerHTML = actHTML;

    // CTA buttons based on tier
    const ctaContainer = document.getElementById('cta-buttons');
    if (tier === "High Priority") {
      ctaContainer.innerHTML = `
        <button class="cta-primary" id="cta-talk">Talk to a Fractional Head of People / CPO</button>
        <button id="email-results-btn">Email me my 1-page action plan</button>
      `;
    } else if (tier === "Build Now") {
      ctaContainer.innerHTML = `
        <button class="cta-primary" id="cta-call">Book a diagnostic call</button>
        <button id="email-results-btn">Email me my 1-page action plan</button>
      `;
    } else {
      ctaContainer.innerHTML = `
        <button class="cta-primary" id="email-results-btn">Email me my 1-page action plan</button>
      `;
    }

    // Re-attach email modal listener (since button was just re-created)
    document.getElementById('email-results-btn').addEventListener('click', openModal);
  }

  // ─── Modal ───────────────────────────────────────────────────────────────────

  function openModal() {
    successMessage.classList.add('hidden');
    errorMessage.classList.add('hidden');
    sendingIndicator.classList.add('hidden');
    leadCaptureModal.classList.add('active');
  }

  leadCaptureModal.addEventListener('click', (e) => {
    if (e.target === leadCaptureModal) leadCaptureModal.classList.remove('active');
  });

  // ─── Build Email Content ─────────────────────────────────────────────────────

  function buildEmailContent(firstName, scores, tier, overallScore, actions) {
    const tierDescriptions = {
      "High Priority":
        "People-system risk is likely slowing growth and increasing operational strain. This is a strong signal to bring in experienced people leadership support now.",
      "Build Now":
        "Multiple people-system issues are likely affecting execution, leader effectiveness, or hiring quality. A structured people operating plan is recommended in the near term.",
      "Emerging":
        "Early signals are present. It is worth planning now so issues do not compound as you grow. A light-touch engagement or targeted support may be beneficial.",
      "Foundation Strong":
        "Your people systems appear relatively stable for your current stage. Keep monitoring and strengthen a few areas before they become bottlenecks."
    };

    let categoryScoresText = '';
    sections.forEach(section => {
      const score = scores[section.key];
      const risk  = getSectionRiskLabel(score);
      categoryScoresText += `${section.key}: ${score.toFixed(1)} / 100 (${risk.label})<br>`;
    });

    const highRisk     = sections.filter(s => scores[s.key] >= 80).sort((a,b) => scores[b.key] - scores[a.key]);
    const actionNeeded = sections.filter(s => scores[s.key] >= 60 && scores[s.key] < 80).sort((a,b) => scores[b.key] - scores[a.key]);
    const watching     = sections.filter(s => scores[s.key] >= 50 && scores[s.key] < 60);
    const riskList     = [...highRisk, ...actionNeeded].slice(0, 3);

    let riskText = '';
    if (riskList.length === 0) {
      if (watching.length > 0) {
        riskText = `No categories are currently in the high-risk zone, but the following areas are emerging and worth monitoring: ${watching.map(s => s.key).join(', ')}.`;
      } else {
        riskText = 'No categories are currently in the high-risk zone.';
      }
    } else {
      riskList.forEach(s => {
        const risk = getSectionRiskLabel(scores[s.key]);
        riskText += `${s.key}: ${scores[s.key].toFixed(1)} / 100 (${risk.label})<br>`;
      });
    }

    let actionsText = '';
    actions.forEach((a, i) => {
      actionsText += `${i + 1}. ${a}<br>`;
    });

    return {
      first_name:           firstName || 'there',
      overall_score:        overallScore.toFixed(1),
      tier:                 tier,
      tier_description:     tierDescriptions[tier],
      category_scores:      categoryScoresText,
      risk_signals:         riskText,
      recommended_actions:  actionsText
    };
  }

  // ─── Submit Email ────────────────────────────────────────────────────────────

  document.getElementById('submit-email').addEventListener('click', () => {
    const email      = emailInput.value.trim();
    const firstName  = document.getElementById('first-name').value.trim();
    const wantsInsights = document.getElementById('insights-checkbox').checked;

    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      emailInput.style.borderColor = 'red';
      return;
    }
    emailInput.style.borderColor = '#ccc';

    const submitBtn = document.getElementById('submit-email');
    submitBtn.disabled = true;
    sendingIndicator.classList.remove('hidden');
    successMessage.classList.add('hidden');
    errorMessage.classList.add('hidden');

    const templateParams = buildEmailContent(
      firstName, globalScores, globalTier, globalOverallScore, globalActions
    );
    templateParams.user_email     = email;
    templateParams.wants_insights = wantsInsights ? 'Yes' : 'No';

    const sendToUser  = emailjs.send('elevateIntent_service', 'user_results',       templateParams);
    const sendToAdmin = emailjs.send('elevateIntent_service', 'admin_notification', templateParams);

    Promise.all([sendToUser, sendToAdmin])
      .then(() => {
        sendingIndicator.classList.add('hidden');
        successMessage.classList.remove('hidden');
        submitBtn.disabled = false;
      })
      .catch((error) => {
        console.error('EmailJS error:', error);
        sendingIndicator.classList.add('hidden');
        errorMessage.classList.remove('hidden');
        submitBtn.disabled = false;
      });
  });

  // ─── Restart ─────────────────────────────────────────────────────────────────

  document.getElementById('restart-btn').addEventListener('click', () => {
    location.reload();
  });

</script>
</body>
</html>
